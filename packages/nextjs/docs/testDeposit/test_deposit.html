<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XTG å……å€¼æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .network-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.loading {
            opacity: 0.7;
            cursor: wait;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .balance-display {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        .balance-label {
            color: #666;
            font-size: 14px;
        }

        .balance-value {
            font-weight: 600;
            color: #333;
        }

        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            margin-right: 8px;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 10px;
        }

        .fee-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” XTG å……å€¼æµ‹è¯•</h1>
        <p class="subtitle">BSC Testnet - TCM Token Vault</p>

        <div class="network-info">
            <strong>âš ï¸ ç½‘ç»œè¦æ±‚:</strong> è¯·ç¡®ä¿ MetaMask è¿æ¥åˆ° BSC Testnet<br>
            <small>RPC URL: https://data-seed-prebsc-1-s1.binance.org:8545/</small>
        </div>

        <!-- æ­¥éª¤ 1: è¿æ¥é’±åŒ… -->
        <div class="section">
            <h3><span class="step-number">1</span>è¿æ¥é’±åŒ…</h3>
            <button id="connectBtn" onclick="connectWallet()">è¿æ¥ MetaMask</button>
            <div id="walletStatus" class="status info">æœªè¿æ¥é’±åŒ…</div>
        </div>

        <!-- æ­¥éª¤ 2: æŸ¥çœ‹ä½™é¢ -->
        <div class="section">
            <h3><span class="step-number">2</span>æŸ¥çœ‹ä½™é¢</h3>
            <button id="balanceBtn" onclick="checkBalances()" disabled>åˆ·æ–°ä½™é¢</button>
            <div id="balanceResult" class="balance-display" style="display: none;">
                <div class="balance-item">
                    <span class="balance-label">é’±åŒ…åœ°å€:</span>
                    <span class="balance-value" id="walletAddress">-</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">TCM ä»£å¸ä½™é¢:</span>
                    <span class="balance-value" id="tokenBalance">-</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">å·²æˆæƒé¢åº¦:</span>
                    <span class="balance-value" id="allowanceAmount">-</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">BNB ä½™é¢:</span>
                    <span class="balance-value" id="bnbBalance">-</span>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤ 3: æˆæƒåˆçº¦ -->
        <div class="section">
            <h3><span class="step-number">3</span>æˆæƒåˆçº¦</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                ğŸ’¡ é¦–æ¬¡å……å€¼éœ€è¦æˆæƒåˆçº¦ä½¿ç”¨æ‚¨çš„ TCM ä»£å¸ï¼ˆä»…éœ€ä¸€æ¬¡ï¼‰
            </p>
            <button id="approveBtn" onclick="approveContract()" disabled>æˆæƒåˆçº¦</button>
            <div id="approveResult"></div>
        </div>

        <!-- æ­¥éª¤ 4: å……å€¼ -->
        <div class="section">
            <h3><span class="step-number">4</span>å……å€¼åˆ° Vault</h3>
            <div class="input-group">
                <label for="depositAmount">å……å€¼æ•°é‡ (TCM)</label>
                <input
                    type="number"
                    id="depositAmount"
                    placeholder="ä¾‹å¦‚: 100"
                    step="0.000000000000000001"
                    min="0"
                >
            </div>
            <button id="depositBtn" onclick="deposit()" disabled>å……å€¼</button>
            <div id="depositResult"></div>
        </div>

        <!-- è¯´æ˜ -->
        <div class="section">
            <h3>ğŸ“ å……å€¼è¯´æ˜</h3>
            <div style="color: #666; font-size: 14px; line-height: 1.8;">
                <p><strong>å……å€¼æµç¨‹:</strong></p>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>è¿æ¥ MetaMask é’±åŒ…</li>
                    <li>æˆæƒåˆçº¦ä½¿ç”¨ TCM ä»£å¸ï¼ˆé¦–æ¬¡éœ€è¦ï¼Œä¹‹åå¯è·³è¿‡ï¼‰</li>
                    <li>è¾“å…¥å……å€¼æ•°é‡å¹¶ç¡®è®¤</li>
                    <li>åœ¨ MetaMask ä¸­ç¡®è®¤äº¤æ˜“</li>
                    <li>ç­‰å¾…äº¤æ˜“ç¡®è®¤ï¼ˆçº¦ 3-5 ç§’ï¼‰</li>
                    <li>åŒºå—é“¾ç›‘å¬å™¨è‡ªåŠ¨æ›´æ–°æ‚¨çš„è™šæ‹Ÿä½™é¢</li>
                </ol>

                <p style="margin-top: 15px;"><strong>æ³¨æ„äº‹é¡¹:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>è¯·ç¡®ä¿åœ¨ BSC Testnet æµ‹è¯•ç½‘æ“ä½œ</li>
                    <li>éœ€è¦è¶³å¤Ÿçš„ BNB æ”¯ä»˜ gas è´¹ç”¨</li>
                    <li>å……å€¼çš„æœ€å°å•ä½æ˜¯ 1 wei (10^-18 TCM)</li>
                    <li>å……å€¼åè™šæ‹Ÿä½™é¢ä¼šåœ¨çº¦ 12 ç§’å†…æ›´æ–°</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script>
        // åˆçº¦é…ç½®
        const CONFIG = {
            TCM_TOKEN_ADDRESS: '0x6dE2c12780F547A9f8dD3A7b83C82A2d41FC38C8', // BSC Testnet
            CHAIN_ID: 97, // BSC Testnet
            CHAIN_NAME: 'BSC Testnet'
        };

        // å…¨å±€å˜é‡
        let provider = null;
        let signer = null;
        let userAddress = null;
        let tokenContract = null;

        // TCM Token ABI (åªéœ€è¦ç”¨åˆ°çš„å‡½æ•°)
        const TCM_TOKEN_ABI = [
            // æŸ¥è¯¢ä½™é¢
            "function balanceOf(address owner) view returns (uint256)",
            // æˆæƒ
            "function approve(address spender, uint256 amount) returns (bool)",
            // æŸ¥è¯¢æˆæƒé¢åº¦
            "function allowance(address owner, address spender) view returns (uint256)",
            // å……å€¼åˆ° vault
            "function deposit(uint256 amount)",
            // æŸ¥è¯¢ vault ä½™é¢
            "function vaultBalanceOf(address owner) view returns (uint256)",
            // ä»£å¸ä¿¡æ¯
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)"
        ];

        // 1. è¿æ¥é’±åŒ…
        async function connectWallet() {
            const statusDiv = document.getElementById('walletStatus');
            const connectBtn = document.getElementById('connectBtn');

            try {
                connectBtn.classList.add('loading');
                statusDiv.className = 'status info';
                statusDiv.innerHTML = 'â³ æ­£åœ¨è¿æ¥é’±åŒ…...';

                // æ£€æŸ¥æ˜¯å¦å®‰è£… MetaMask
                if (!window.ethereum) {
                    throw new Error('è¯·å…ˆå®‰è£… MetaMask é’±åŒ…æ’ä»¶');
                }

                // è¯·æ±‚è¿æ¥
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (network.chainId !== CONFIG.CHAIN_ID) {
                    throw new Error(`è¯·åˆ‡æ¢åˆ° ${CONFIG.CHAIN_NAME} (Chain ID: ${CONFIG.CHAIN_ID})`);
                }

                // åˆ›å»ºåˆçº¦å®ä¾‹
                tokenContract = new ethers.Contract(
                    CONFIG.TCM_TOKEN_ADDRESS,
                    TCM_TOKEN_ABI,
                    signer
                );

                // æˆåŠŸ
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `âœ… é’±åŒ…å·²è¿æ¥<br><small>${userAddress}</small>`;

                // å¯ç”¨å…¶ä»–æŒ‰é’®
                document.getElementById('balanceBtn').disabled = false;
                document.getElementById('approveBtn').disabled = false;
                document.getElementById('depositBtn').disabled = false;

                // è‡ªåŠ¨åˆ·æ–°ä½™é¢
                await checkBalances();

            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `âŒ è¿æ¥å¤±è´¥: ${error.message}`;
            } finally {
                connectBtn.classList.remove('loading');
            }
        }

        // 2. æŸ¥çœ‹ä½™é¢
        async function checkBalances() {
            const resultDiv = document.getElementById('balanceResult');
            const balanceBtn = document.getElementById('balanceBtn');

            try {
                balanceBtn.classList.add('loading');
                resultDiv.style.display = 'block';

                // è·å–ä»£å¸ä½™é¢
                const tokenBalance = await tokenContract.balanceOf(userAddress);
                const tokenDecimals = await tokenContract.decimals();
                const tokenSymbol = await tokenContract.symbol();

                // è·å–æˆæƒé¢åº¦ (æˆæƒç»™è‡ªå·±è°ƒç”¨ deposit)
                const allowance = await tokenContract.allowance(
                    userAddress,
                    CONFIG.TCM_TOKEN_ADDRESS
                );

                // è·å– BNB ä½™é¢
                const bnbBalance = await provider.getBalance(userAddress);

                // è·å– vault ä½™é¢
                const vaultBalance = await tokenContract.vaultBalanceOf(userAddress);

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('walletAddress').textContent =
                    `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                document.getElementById('tokenBalance').textContent =
                    `${formatToken(tokenBalance, tokenDecimals)} ${tokenSymbol}`;
                document.getElementById('allowanceAmount').textContent =
                    `${formatToken(allowance, tokenDecimals)} ${tokenSymbol}`;
                document.getElementById('bnbBalance').textContent =
                    `${formatBNB(bnbBalance)} BNB`;

                // æ˜¾ç¤º vault ä½™é¢æç¤º
                if (parseFloat(formatToken(vaultBalance, tokenDecimals)) > 0) {
                    document.getElementById('tokenBalance').innerHTML +=
                        `<br><small style="color: #666;">Vault: ${formatToken(vaultBalance, tokenDecimals)} ${tokenSymbol}</small>`;
                }

            } catch (error) {
                console.error('æŸ¥è¯¢ä½™é¢å¤±è´¥:', error);
                resultDiv.innerHTML = `<div class="status error">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
            } finally {
                balanceBtn.classList.remove('loading');
            }
        }

        // 3. æˆæƒåˆçº¦
        async function approveContract() {
            const resultDiv = document.getElementById('approveResult');
            const approveBtn = document.getElementById('approveBtn');

            try {
                approveBtn.classList.add('loading');
                resultDiv.className = 'status info';
                resultDiv.innerHTML = 'â³ æ­£åœ¨æˆæƒ...';

                // è·å–ä»£å¸ç²¾åº¦
                const tokenDecimals = await tokenContract.decimals();
                const maxAmount = ethers.BigNumber.from(2).pow(256).sub(1); // æ— é™æˆæƒ

                // è°ƒç”¨ approve å‡½æ•°
                const tx = await tokenContract.approve(
                    CONFIG.TCM_TOKEN_ADDRESS, // spender æ˜¯åˆçº¦åœ°å€
                    maxAmount
                );

                resultDiv.innerHTML = `â³ äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...<br><small>TX: ${tx.hash}</small>`;

                // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                await tx.wait();

                resultDiv.className = 'status success';
                resultDiv.innerHTML = `âœ… æˆæƒæˆåŠŸï¼<br><small>TX: ${tx.hash}</small>`;

                // åˆ·æ–°ä½™é¢
                setTimeout(() => checkBalances(), 2000);

            } catch (error) {
                console.error('æˆæƒå¤±è´¥:', error);
                resultDiv.className = 'status error';
                resultDiv.innerHTML = `âŒ æˆæƒå¤±è´¥: ${error.message}`;
            } finally {
                approveBtn.classList.remove('loading');
            }
        }

        // 4. å……å€¼
        async function deposit() {
            const resultDiv = document.getElementById('depositResult');
            const depositBtn = document.getElementById('depositBtn');
            const amountInput = document.getElementById('depositAmount');

            try {
                const amount = amountInput.value.trim();

                // éªŒè¯è¾“å…¥
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„å……å€¼æ•°é‡');
                }

                depositBtn.classList.add('loading');
                resultDiv.className = 'status info';
                resultDiv.innerHTML = 'â³ æ­£åœ¨å……å€¼...';

                // è·å–ä»£å¸ç²¾åº¦
                const tokenDecimals = await tokenContract.decimals();

                // è½¬æ¢ä¸º wei
                const amountWei = ethers.utils.parseUnits(amount, tokenDecimals);

                // æ£€æŸ¥ä½™é¢
                const balance = await tokenContract.balanceOf(userAddress);
                if (balance.lt(amountWei)) {
                    throw new Error('ä»£å¸ä½™é¢ä¸è¶³');
                }

                // è°ƒç”¨ deposit å‡½æ•°
                const tx = await tokenContract.deposit(amountWei);

                resultDiv.innerHTML = `â³ äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...<br>
                    <small>TX: ${tx.hash}</small>
                    <p class="fee-info">ğŸ’¡ çº¦ 12 ç§’ååŒºå—é“¾ç›‘å¬å™¨ä¼šè‡ªåŠ¨æ›´æ–°æ‚¨çš„è™šæ‹Ÿä½™é¢</p>
                `;

                // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                const receipt = await tx.wait();

                resultDiv.className = 'status success';
                resultDiv.innerHTML = `âœ… å……å€¼æˆåŠŸï¼<br>
                    <small>TX: ${tx.hash}</small><br>
                    <small>Block: ${receipt.blockNumber}</small><br>
                    <small>Gas Used: ${receipt.gasUsed.toString()}</small><br>
                    <br>
                    <strong>ğŸ’¡ åŒºå—é“¾ç›‘å¬å™¨å°†åœ¨çº¦ 12 ç§’åè‡ªåŠ¨æ›´æ–°æ‚¨çš„è™šæ‹Ÿä½™é¢</strong>
                    <br><br>
                    <button onclick="checkBalances()" style="padding: 8px 16px; font-size: 14px;">åˆ·æ–°ä½™é¢æŸ¥çœ‹</button>
                `;

                // æ¸…ç©ºè¾“å…¥
                amountInput.value = '';

                // 5 ç§’åè‡ªåŠ¨åˆ·æ–°ä½™é¢
                setTimeout(() => checkBalances(), 5000);

            } catch (error) {
                console.error('å……å€¼å¤±è´¥:', error);
                resultDiv.className = 'status error';

                // ç”¨æˆ·æ‹’ç»äº¤æ˜“
                if (error.code === 4001) {
                    resultDiv.innerHTML = `âŒ æ‚¨å·²å–æ¶ˆäº¤æ˜“`;
                } else {
                    resultDiv.innerHTML = `âŒ å……å€¼å¤±è´¥: ${error.message}`;
                }
            } finally {
                depositBtn.classList.remove('loading');
            }
        }

        // æ ¼å¼åŒ–ä»£å¸æ•°é‡
        function formatToken(amount, decimals) {
            const formatted = ethers.utils.formatUnits(amount, decimals);
            const num = parseFloat(formatted);

            if (num === 0) return '0';
            if (num < 0.000001) return formatted;
            if (num < 1) return parseFloat(formatted).toFixed(6);
            return parseFloat(formatted).toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 6
            });
        }

        // æ ¼å¼åŒ– BNB
        function formatBNB(amount) {
            const formatted = ethers.utils.formatEther(amount);
            const num = parseFloat(formatted);

            if (num < 0.001) return '< 0.001';
            return parseFloat(formatted).toFixed(4);
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // ç”¨æˆ·æ–­å¼€è¿æ¥
                    location.reload();
                } else {
                    // ç”¨æˆ·åˆ‡æ¢è´¦æˆ·
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', () => {
                // ç”¨æˆ·åˆ‡æ¢ç½‘ç»œ
                location.reload();
            });
        }
    </script>
</body>
</html>
